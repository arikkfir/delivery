apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: "${ENVIRONMENT}"
commonAnnotations:
  kfirs.com/branch: "${BRANCH}"
  kfirs.com/environment: "${ENVIRONMENT}"
resources:
  - ../main
patches:
  - patch: |-
      - op: replace
        path: /metadata/name
        value: "${ENVIRONMENT}"
    target:
      group: ""
      version: v1
      kind: Namespace

  # Fix the environment name & use ACME staging in all kustomizations
  - patch: |
      - op: replace
        path: /spec/targetNamespace
        value: "${ENVIRONMENT}"
      - op: replace
        path: /spec/postBuild/substitute/deploy_environment
        value: "${ENVIRONMENT}"
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: cert-manager.io
            version: v1
            kind: Certificate
          patch: |-
            - op: replace
              path: /spec/issuerRef/name
              value: google-clouddns
    target:
      group: kustomize.toolkit.fluxcd.io
      version: v1
      kind: Kustomization

  # Fix health checks of the greenstar kustomization
  - patch: |
      - op: replace
        path: /spec/healthChecks/0/namespace
        value: "${ENVIRONMENT}"
      - op: replace
        path: /spec/healthChecks/1/namespace
        value: "${ENVIRONMENT}"
      - op: replace
        path: /spec/healthChecks/2/namespace
        value: "${ENVIRONMENT}"
      - op: replace
        path: /spec/healthChecks/3/namespace
        value: "${ENVIRONMENT}"
      - op: replace
        path: /spec/healthChecks/4/namespace
        value: "${ENVIRONMENT}"
      - op: replace
        path: /spec/healthChecks/5/namespace
        value: "${ENVIRONMENT}"
    target:
      group: kustomize.toolkit.fluxcd.io
      version: v1
      kind: Kustomization
      name: greenstar
